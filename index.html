<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Neaspace WhatsApp Access</title>
<style>
  :root{--fg:#111;--muted:#666;--ok:#0a6800;--err:#b00020;--btn:#007bff;--btnH:#0056b3}
  body{margin:0;font:500 16px/1.5 system-ui,-apple-system,"Segoe UI",Roboto,Arial,sans-serif;color:var(--fg)}
  .wrap{max-width:680px;margin:0 auto;padding:28px 16px}
  h1{font-size:20px;margin:0 0 12px}
  .card{border:1px solid #eee;border-radius:12px;padding:18px;margin-top:12px;box-shadow:0 2px 6px rgba(0,0,0,.06)}
  .muted{color:var(--muted);font-size:14px}
  .ok{color:var(--ok);font-weight:700}
  .err{color:var(--err);font-weight:700}
  .btn{display:inline-block;padding:10px 18px;border-radius:8px;background:var(--btn);color:#fff;text-decoration:none;font-weight:700}
  .btn:hover{background:var(--btnH)}
  .btn[aria-disabled="true"]{opacity:.6;pointer-events:none}
  .row{margin:6px 0}
  code{background:#f6f6f6;border:1px solid #eee;border-radius:6px;padding:2px 6px}
</style>
</head>
<body>
  <div class="wrap">
    <h1>Neaspace WhatsApp Access</h1>
    <div class="card" id="panel">
      <div class="row muted">Verifying your stay window…</div>
    </div>
  </div>

<script>
(function(){
  // CONFIG
  const TZ   = 'Europe/Paris';              // Nice time
  const TO   = '393283887637';              // WhatsApp number (no +)
  const TEXT = '#Neaspace19RueNeuve';       // message to send (no booking ID)

  // Query params
  const qs = new URLSearchParams(location.search);
  const arrivalStr   = qs.get('arrival')   || qs.get('checkin');
  const departureStr = qs.get('departure') || qs.get('checkout');

  // ---- Robust date parsing ----
  function toFourDigitYear(yy){
    yy = Number(yy);
    return yy < 70 ? 2000 + yy : 1900 + yy;  // 00–69 => 2000–2069, 70–99 => 1970–1999
  }

  function parseFlexibleDate(s){
    if(!s) return null;
    s = String(s).trim();
    let m;

    // YYYY-MM-DD (and variants with T…)
    if((m = s.match(/^(\d{4})-(\d{2})-(\d{2})(?:T.*)?$/))){
      const y=+m[1], mo=+m[2]-1, d=+m[3];
      return new Date(Date.UTC(y, mo, d));
    }
    // DD.MM.YY or DD.MM.YYYY
    if((m = s.match(/^(\d{2})\.(\d{2})\.(\d{2}|\d{4})$/))){
      const d=+m[1], mo=+m[2]-1, y=(m[3].length===2? toFourDigitYear(m[3]) : +m[3]);
      return new Date(Date.UTC(y, mo, d));
    }
    // Slash: autodetect MM/DD/YYYY vs DD/MM/YYYY (preferisci MM/DD se ambigui)
    if((m = s.match(/^(\d{1,2})\/(\d{1,2})\/(\d{2}|\d{4})$/))){
      let a=+m[1], b=+m[2], y=(m[3].length===2? toFourDigitYear(m[3]) : +m[3]);
      let d, mo;
      if (a > 12 && b <= 12) {        // DD/MM/YYYY
        d = a; mo = b - 1;
      } else if
